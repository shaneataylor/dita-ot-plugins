<?xml version="1.0" encoding="UTF-8"?>

<project name="build_ditasearch_targets" basedir="."
    xmlns:dita="http://dita-ot.sourceforge.net">
    
    <taskdef resource="net/sf/antcontrib/antcontrib.properties">
        <classpath>
            <pathelement location="${dita.plugin.com.taylortext.ditasearch.dir}/lib/ant-contrib/ant-contrib-1.0b3.jar"/>
        </classpath>
    </taskdef>
    
    <!--<property name="args.ditasearch.configs" value="true"/>-->
    
    <!-- PREPROCESSING -->
    <target name="gen-nosearch-list">
        <xslt basedir="${dita.temp.dir}"
            includesfile="${dita.temp.dir}/fullditamap.list" 
            destdir="${dita.temp.dir}"
            style="${dita.plugin.com.taylortext.ditasearch.dir}/xsl/gen-nosearch-list.xsl"
            failOnError="true" extension=".nosearch">
            <xmlcatalog refid="dita.catalog"/>
        </xslt>
        <concat destfile="${dita.temp.dir}/nosearch.list" fixlastline="yes">
            <path>
                <fileset dir="${dita.temp.dir}">
                    <include name="*.nosearch"/>
                    <include name="resourceonly.list"/>
                </fileset>
            </path>
            <filterchain><!-- sort list entries and remove duplicates -->
                <sortfilter/>
                <tokenfilter>
                    <uniqfilter/>
                </tokenfilter>
            </filterchain>
        </concat>
        <loadfile property="nosearchlist" srcfile="${dita.temp.dir}/nosearch.list"/>
    </target>
    
    <!-- MAIN -->
    <target name="gen-index" 
        dita:depends="
            {com.taylortext.ditasearch.pre}, 
            ditasearch-searchindex,
            {com.taylortext.ditasearch.post}
            "
        dita:extension="depends org.dita.dost.platform.InsertDependsAction">
        <dita:extension id="com.taylortext.ditasearch.pre" behavior="org.dita.dost.platform.InsertAction"/>
        <dita:extension id="com.taylortext.ditasearch.post" behavior="org.dita.dost.platform.InsertAction"/>
    </target>
    
    <target name="ditasearch-searchindex" description="Generate a JSON index of the help content."
        depends="ditasearch-configfile">
        <!-- Future: generate & use searchtargets list of topics for which @search != no -->
        <!-- Index each topic individually first -->
        <xslt basedir="${dita.temp.dir}"
            includesfile="${dita.temp.dir}/fullditatopic.list"
            excludesfile="${dita.temp.dir}/nosearch.list"
            destdir="${dita.temp.dir}"
            style="${dita.plugin.com.taylortext.ditasearch.dir}/xsl/stemmer.xsl"
            filenameparameter="thisindextarget"
            failOnError="false" extension=".idx">
            <param name="OUTEXT" expression="${out.ext}" if="out.ext"/>
            <param name="configfile" expression="${dita.temp.dir}/searchconfigs.xml"/>
            <xmlcatalog refid="dita.catalog"/>
        </xslt>
        <!-- Combine all topic indexes into a single file for further processing -->
        <concat destfile="${dita.temp.dir}/allstems.idx">
            <fileset dir="${dita.temp.dir}" includes="*.idx" excludes="allstems.idx"/>
            <header filtering="no"><![CDATA[<?xml version="1.0" encoding="UTF-8"?>
<indextopics>]]></header>
            <footer filtering="no"><![CDATA[</indextopics>]]></footer>
        </concat>
        <delete>
            <fileset dir="${dita.temp.dir}" includes="*.idx" excludes="allstems.idx"/>
        </delete>
        <!-- Generate JSON index file -->
        <xslt in="${dita.temp.dir}/allstems.idx"
            out="${dita.temp.dir}/helpindex.json"
            style="${dita.plugin.com.taylortext.ditasearch.dir}/xsl/stems2helpindex.xsl"
            failOnError="false">
            <xmlcatalog refid="dita.catalog"/>
        </xslt>
        <!-- Generate JSON topicsummaries file -->
        <xslt in="${dita.temp.dir}/allstems.idx"
            out="${dita.temp.dir}/topicsummaries.json"
            style="${dita.plugin.com.taylortext.ditasearch.dir}/xsl/topicsummaries.xsl"
            failOnError="false">
            <xmlcatalog refid="dita.catalog"/>
        </xslt>
        <copy file="${dita.plugin.com.taylortext.ditasearch.dir}/js/ditasearch.js"
            todir="${dita.temp.dir}">
            <filterchain>
                <tailfilter lines="-1" skip="20"/><!-- Remove the last 20 lines -->
            </filterchain>
        </copy>
        <concat destfile="${output.dir}/ditasearch.js">
            <file file="${dita.temp.dir}/ditasearch.js"/>
            <!-- TO DO: ADD STRINGS FILE/CONFIG -->
            <file file="${dita.temp.dir}/searchconfigs.json"/>
            <file file="${dita.temp.dir}/helpindex.json"/>
            <file file="${dita.temp.dir}/topicsummaries.json"/>
            <file file="${dita.plugin.com.taylortext.ditasearch.dir}/js/selfexecute.js"/>
        </concat>
    </target>
    
    <target name="ditasearch-configfile" description="Construct the XML and JSON indexing config data.">
        <condition property="configfile.found" value="true" else="false">
            <available file="${args.ditasearch.configs}"/>
        </condition>
        
        <!-- Combine user and default search configs -->
        <xslt in="${dita.plugin.com.taylortext.ditasearch.dir}/default-configs.xml"
            out="${dita.temp.dir}/searchconfigs.xml"
            style="${dita.plugin.com.taylortext.ditasearch.dir}/xsl/init_searchconfigs.xsl"
            failOnError="true">
            <param name="configfile" expression="${args.ditasearch.configs}"/>
            <param name="configfilefound" expression="${configfile.found}"/>
            <xmlcatalog refid="dita.catalog"/>
        </xslt>
        <xslt in="${dita.temp.dir}/searchconfigs.xml"
            out="${dita.temp.dir}/searchconfigs.json"
            style="${dita.plugin.com.taylortext.ditasearch.dir}/xsl/searchconfigs2json.xsl"
            failOnError="true">
            <xmlcatalog refid="dita.catalog"/>
        </xslt>
    </target>
    
</project>